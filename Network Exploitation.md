# NETWORK EXPLOITATION

## Executive Summary
| Virtual Machine | Windows 7 | Kali Linux | Metasploitable 2 |
| ------------- | ------------- | ------------- | ------------- |
| IP Address | 192.168.1.23 | 192.168.1.24 | 192.168.1.22 |
| Subnet Mask | 255.255.255.0 | 255.255.255.0 | 255.255.255.0 |
| Default Gateway | 192.168.1.255 | 192.168.1.255 | 192.168.1.255 |

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Eternalblue is a remote code execution exploit that targets a vulnerability in the SMB protocol (Server Message Block) on Windows systems. The vulnerability is caused by a flaw in the way that the SMB protocol handles certain packets. Specifically, the exploit takes advantage of a buffer overflow in the SMBv1 server component, which can allow an attacker to execute arbitrary code on a target system with SYSTEM privileges.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Doublepulsar is a backdoor implant that is installed on vulnerable systems using the Eternalblue exploit. It is a kernel-mode payload that allows attackers to maintain persistent access to the system even after a reboot. Doublepulsar can be used to execute arbitrary code, install additional malware, or steal sensitive data.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The combination of Eternalblue and Doublepulsar is a potent threat, as it allows attackers to gain remote access to vulnerable systems and maintain persistent access without being detected. The vulnerability was widely exploited in various high-profile attacks, such as the WannaCry ransomware attack in 2017, which affected hundreds of thousands of computers worldwide.

### Business Impact
- **Data Breach**: If these vulnerabilities are exploited, it could lead to a data breach, which could result in sensitive business information being accessed by unauthorized individuals. This could lead to reputational damage for the organization, loss of customer trust, and legal and financial consequences.
- **Downtime**: Exploitation of these vulnerabilities could result in downtime for the organization's systems, as the attackers could gain control over the affected servers or networks. This downtime could impact the organization's ability to conduct business operations, leading to potential revenue losses.
- **Financial Loss**: In addition to revenue losses due to downtime, the organization could face other financial losses such as the cost of remediation, legal and regulatory fines, and potential legal settlements or judgments.
- **Loss of Productivity**: If the organization's systems are compromised, it could lead to a loss of productivity as employees may not be able to access the systems they need to perform their job duties.
- **Damage to Reputation**: A successful attack on the organization's systems could damage the company's reputation, leading to a loss of customer trust and potential future business opportunities.
- **Legal Liability**: If sensitive data is compromised as a result of these vulnerabilities being exploited, the organization could face legal liability for not properly securing their systems.
- **Regulatory Compliance**: Depending on the industry the organization operates in, they may be subject to regulatory requirements that mandate certain security standards. If these vulnerabilities are exploited, the organization may fail to meet these requirements, leading to potential legal and financial consequences.

## Metasploitable 2

**exploit(multi/http/php_cgi_arg_injection)**
```ruby
msfconsole
search exploit
show exploit(multi/http/php_cgi_arg_injection)
set RHOST 192.168.1.22
run
```

- The **`multi/http/php_cgi_arg_injection`** exploit in Metasploit targets a vulnerability in PHP-CGI that allows an attacker to execute arbitrary code on the target system.
- PHP-CGI is a Common Gateway Interface (CGI) interface that allows web servers to execute PHP scripts. The vulnerability exists in the way PHP-CGI handles query strings passed in the **`QUERY_STRING`** environment variable. By injecting specially crafted query strings, an attacker can cause PHP-CGI to execute arbitrary code.
- The **`multi/http/php_cgi_arg_injection`** exploit module in Metasploit sends a crafted request to the target system's PHP-CGI server, which triggers the vulnerability and allows the attacker to execute arbitrary code. The exploit can be used to gain a remote shell on the target system with the privileges of the user running the PHP-CGI server.

**exploit(unix/ftp/vsftpd 234 backdoor)**
```ruby
msfconsole
search exploit
show exploit/unix/ftp/vsftpd_234_backdoor
set RHOST 192.168.1.22
run
```

- The **`unix/ftp/vsftpd 234 backdoor`** exploit targets a backdoor that was present in the vsftpd FTP server version 2.3.4. The backdoor was intentionally inserted by the original author of vsftpd, and was discovered in 2011 by a security researcher.
- The backdoor allows an attacker to authenticate to the vsftpd server using a hard-coded username and password combination, which grants the attacker access to a remote shell with root privileges on the target system. This vulnerability could be exploited remotely, without requiring any credentials or authentication.
- The **`unix/ftp/vsftpd 234 backdoor`** exploit module in Metasploit attempts to exploit this vulnerability by sending a specially crafted string of characters to the target system's vsftpd server, which triggers the backdoor and allows the attacker to gain access to the remote shell with root privileges. Once the attacker has gained access to the remote shell, they can execute arbitrary commands and take full control of the target system.   

## Windows 7

**exploit/windows/smb/eternalblue_doublepulsar.rb**
```ruby
msfconsole
search doublepulsar
show exploit/windows/smb/eternalblue_doublepulsar.rb
show options
set RHOST 192.168.1.23
set RPORT 445
show options
run
```
- **`search doublepulsar`** and pressing Enter. This will display a list of available modules related to DoublePulsar.
- Select the ***exploit/windows/smb/eternalblue_doublepulsar.rb*** module by typing **`use exploit/windows/smb/eternalblue_doublepulsar.rb`**. This will select the module and prepare it for use.
- Display the available options for the selected module by typing "show options" and pressing Enter. This will show you which options need to be set for the exploit to work correctly.
- Set the target IP address to the IP address of the vulnerable system you want to exploit by typing **`set RHOST 192.168.1.23`** for the target. 
- Set the target port number to the port number on which the SMB service is running by typing **`set RPORT 445`**. This is the default port number for SMB.

## Binary Exploitation

```ruby
import struct

# ask user for value to overwrite return address
ret_addr = input("Enter return address in hex format (e.g. 0x12345678): ")

# convert hex string to integer
ret_addr_int = int(ret_addr, 16)

# construct payload
payload = b"A" * 40
payload += struct.pack("<Q", ret_addr_int)

print(payload)
```
- The payload is constructed using the struct module to pack data into a binary format.
- The code first prompts the user to enter the memory address of the return address in hexadecimal format, which will be overwritten with a new value to redirect the program flow to an attacker-controlled location.
- The hexadecimal string is then converted to an integer using the **`int()`** function with a base of 16 (hexadecimal). This integer value is used as the argument to **`struct.pack()`**, which packs the value in little-endian byte order (<Q) and returns a bytes object that is concatenated to the payload buffer.

## Recommendations
### Tactical Recommendations:
- **Patch Vulnerable Systems**: The first tactical measure to take is to patch vulnerable systems to prevent attackers from exploiting the vulnerabilities. Software vendors often release security patches to fix known vulnerabilities, so it is critical to apply these patches promptly.
- **Implement Firewalls**: Implementing firewalls can help prevent attackers from gaining access to vulnerable systems. Firewalls can be set up to block traffic from known malicious IP addresses or to allow only specific types of traffic to certain ports.
- **Deploy Intrusion Detection and Prevention Systems**: Intrusion detection and prevention systems (IDPS) can help detect and block malicious traffic. IDPS can identify and block known attack signatures, preventing the attacker from exploiting the vulnerability.
- **Perform Regular Vulnerability Assessments**: Regular vulnerability assessments can help identify vulnerabilities in systems that could be exploited. This can help organizations prioritize patches and other security measures.
- **Conduct Penetration Testing**: Penetration testing can help identify vulnerabilities that might be missed by other security measures. By simulating a real-world attack, penetration testing can identify weaknesses in systems that could be exploited.

### Strategic Recommendations:
- **Implement Security Policies**: Implementing security policies that address vulnerabilities and their mitigation can help ensure that vulnerabilities are identified and addressed promptly.
- **Provide Security Awareness Training**: Providing security awareness training to employees can help prevent attackers from exploiting vulnerabilities through social engineering or other means. Employees can be trained to recognize phishing emails, suspicious activity, and other security risks.
- **Use Secure Coding Practices**: Using secure coding practices can help prevent vulnerabilities from being introduced into software during the development process. Secure coding practices include input validation, output encoding, and using secure coding frameworks and libraries.
- **Implement Network Segmentation**: Implementing network segmentation can help prevent attackers from moving laterally across the network. By separating sensitive systems from less secure systems, network segmentation can help limit the impact of a successful attack.
- **Engage in Threat Intelligence**: Engaging in threat intelligence can help organizations stay abreast of the latest threats and vulnerabilities. By monitoring threat feeds and other sources of information, organizations can identify emerging threats and take steps to mitigate them.
